# @configure_input@

top_builddir = @abs_top_builddir@
srcdir       = @srcdir@
prefix       = @prefix@
exec_prefix  = @exec_prefix@
bindir       = @bindir@
libdir       = @libdir@
includedir   = @includedir@
datarootdir  = @datarootdir@
runstatedir  = @runstatedir@
datadir      = @datadir@
mandir       = @mandir@

VPATH = @srcdir@

INSTALL_OPTIONS  =
INSTALL          = @INSTALL@ $(INSTALL_OPTIONS)
INSTALL_DATA_DIR = @INSTALL_DATA_DIR@
INSTALL_DATA     = @INSTALL_DATA@
INSTALL_PROGRAM  = @INSTALL_PROGRAM@
INSTALL_SCRIPT   = @INSTALL_SCRIPT@
INSTALL_LIBRARY  = @INSTALL_LIBRARY@

PACKAGE_NAME    = @PACKAGE_NAME@
PACKAGE_VERSION = @PACKAGE_VERSION@
PACKAGE_TARNAME = @PACKAGE_TARNAME@

TCL_BIN_DIR	= @TCL_BIN_DIR@
TCL_SRC_DIR	= @TCL_SRC_DIR@
#TK_BIN_DIR	= @TK_BIN_DIR@
#TK_SRC_DIR	= @TK_SRC_DIR@

TDK_TCLKIT = @TDK_TCLKIT@
TDK_TCLSH_PROG = @TDK_TCLSH_PROG@
TDK_WISH_PROG = @TDK_WISH_PROG@

EXTRA_PATH  = $(top_builddir):$(TCL_BIN_DIR):$(TCL_BIN_DIR)/../bin
#TCLLIBPATH  = $(top_builddir)
#TCLSH_ENV   = TCL_LIBRARY=`@CYGPATH@ $(TCL_SRC_DIR)/library`

#PKG_ENV = @LD_LIBRARY_PATH_VAR@="$(EXTRA_PATH):$(@LD_LIBRARY_PATH_VAR@)" \
#	PATH="$(EXTRA_PATH):$(PATH)" \
#	TCLLIBPATH="$(TCLLIBPATH)"
#
#TCLSH_PROG = @TDK_TCLSH_PROG@
#TCLSH      = $(TCLSH_ENV) $(PKG_ENV) $(TCLSH_PROG)

all: tbcload tclcompiler tclparser apps

tbcload:
	cd lib/tbcload && $(MAKE) all

tclcompiler:
	cd lib/tclcompiler && $(MAKE) all

tclparser:
	cd lib/tclparser && $(MAKE) all

apps: apps/tclapp

TDK_COMPILER_PKGS = \
	tbcload \
	tclcompiler \
	tclparser

TDK_INTERNAL_PKGS = \
	afs \
	tcldevkit::appframe \
	hpane \
	checker \
	cmatch \
	engine \
	debugger \
	view \
	vtree \
	help \
	ico \
	image \
	listentry \
	clogwindow \
	teapot::metadata \
	as::cache::async \
	oomk \
	osx::bundle::app \
	tdk_prowrap \
	teapot::package::gen \
	platform \
	pref::devkit \
	pref \
	pref::teapot \
	projectInfo \
	repository::local \
	selfile \
	splash \
	stringfileinfo \
	syscolor \
	tap::db \
	tapscan \
	tcldebugger_attach \
	tdk_appstartup \
	teapot::config \
	teapot::entity \
	teapot::link \
	tlocate \
	toolbar \
	tclapp::wrapengine \
	Entity

TCLAPP_PROG = $(TDK_TCLSH_PROG) $(srcdir)/app/tclapp/entry.tcl

apps/tclapp:
	D="$$(cd $(srcdir); pwd)" ; \
	TOP_LEVEL_FILES=`for file in "$${D}"/artwork "$${D}"/data/images; do printf '%s/* ' "$${file}"; done` ; \
	APP_FILES=`find "$${D}"/app/tclapp -type d` ; \
	APP_FILES_WITH_GLOB=`for file in $${APP_FILES}; do printf '%s/* ' "$${file}"; done` ; \
	PACKAGES=`for pkg in $(TDK_COMPILER_PKGS) $(TDK_INTERNAL_PKGS); do printf -- '-pkg %s ' "$${pkg}"; done` ; \
	TCLAPP_PKGPATH="$${D}" $(TCLAPP_PROG) -relativeto "$${D}"/app/tclapp "$${D}"/app/tclapp/entry.tcl \
		-relativeto "$${D}"/app/tclapp $${APP_FILES_WITH_GLOB} $${PACKAGES} \
		-relativeto "$${D}" $${TOP_LEVEL_FILES} \
		-out "$(top_builddir)/tclapp"


clean:
	cd lib/tclcompiler && $(MAKE) $@
	cd lib/tclparser   && $(MAKE) $@

Makefile: $(srcdir)/Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

#.PHONY: FORCE all clean check dist distcheck install uninstall

.PHONY: all apps clean
